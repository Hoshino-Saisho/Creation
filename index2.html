<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>生产链建筑数量配平计算器</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px 40px; background-color: #f7f7f7; }
        h1, p { color: #333; }
        .info { background-color: #eaf2ff; border-left: 4px solid #5a8dee; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .control-panel { margin-bottom: 20px; }
        .control-panel button { font-size: 16px; padding: 10px 20px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 5px; }
        #calculator-grid { box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px;}
    </style>
</head>
<body>

    <h1>生产链建筑数量配平计算器</h1>
    <div class="info">
        <p><b>使用说明：</b></p>
        <ol>
            <li>在表格中，<b>从上到下</b>依次输入您的生产链建筑 (A -> B -> C)。</li>
            <li>填写每个建筑的<b>“单位产量”</b>和它对<b>“上级产品的消耗量”</b>。</li>
            <li>点击计算，系统会自动找出链条中的“基础单位”建筑（即相对需求量最小的建筑），并将其配平数量设为1，然后计算出其他所有建筑的对应数量。</li>
        </ol>
    </div>

    <div class="control-panel">
        <button id="calculate-button">计算配平数量</button>
    </div>

    <div id="calculator-grid"></div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <script>
        const initialProductionChainData = [
            // [建筑名称, 单位产量, 上级产品消耗量, 配平数量(结果)]
            ['铁矿场', 30, 0, null],
            ['炼铁厂', 30, 30, null],
            ['齿轮厂', 15, 15, null]
        ];

        // 最终版算法：三步配平法
        function calculateChainRatios() {
            const data = hot.getSourceDataArray();
            if (data.length === 0) return;

            // --- 步骤 1: 反向计算，得出相对于最终产品的“相对配比” ---
            const relativeRatios = new Array(data.length);
            relativeRatios[data.length - 1] = 1; // 最后一个建筑的相对配比基准为1

            for (let i = data.length - 2; i >= 0; i--) {
                const upstreamOutput = parseFloat(data[i][1]) || 0;
                const downstreamConsumption = parseFloat(data[i + 1][2]) || 0;

                if (upstreamOutput === 0) {
                    relativeRatios[i] = Infinity;
                } else {
                    // 核心公式：上游配比 = 下游配比 * 下游消耗 / 上游产出
                    relativeRatios[i] = relativeRatios[i+1] * downstreamConsumption / upstreamOutput;
                }
            }
            
            // --- 步骤 2: 找到所有相对配比中的最小值 (即“最小权重”) ---
            let minRatio = Infinity;
            relativeRatios.forEach(ratio => {
                if (ratio > 0 && ratio < minRatio) {
                    minRatio = ratio;
                }
            });

            if (minRatio === Infinity) { // 如果所有比率都是0或无效，则不进行下一步
                minRatio = 1;
            }

            // --- 步骤 3: 使用“1/最小配比”作为全局乘数，计算最终的配平数量 ---
            const globalMultiplier = 1 / minRatio;
            const changes = [];
            relativeRatios.forEach((ratio, index) => {
                const finalAmount = ratio * globalMultiplier;
                changes.push([index, 3, finalAmount]);
            });

            // 一次性将所有计算结果更新到表格
            hot.setDataAtCell(changes);
        }

        const container = document.getElementById('calculator-grid');
        const hot = new Handsontable(container, {
            data: initialProductionChainData,
            colHeaders: ['建筑名称', '单位产量', '上级产品消耗量', '配平数量 (结果)'],
            columns: [
                {}, 
                { type: 'numeric' }, 
                { type: 'numeric' }, 
                { type: 'numeric', readOnly: true, numericFormat: { pattern: '0,0.000' } }
            ],
            rowHeaders: true,
            height: 'auto',
            width: 'auto',
            stretchH: 'all',
            licenseKey: 'non-commercial-and-evaluation'
        });

        document.getElementById('calculate-button').addEventListener('click', calculateChainRatios);
        window.addEventListener('DOMContentLoaded', calculateChainRatios);
    </script>
</body>
</html>
